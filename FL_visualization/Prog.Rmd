---
title: "Visualizing Insights: DHDP Federated Learning in the Identification of New Biomarkers for Immunotherapy Response"
output:
  BiocStyle::html_document
---

# Introduction

In the rapidly evolving field of immuno-oncology, the discovery of effective biomarkers is crucial for advancing personalized treatment strategies. This section explores how Federated Learning (FL) facilitates the identification of new biomarkers for immunotherapy responses. We focus on visualizing FL data to uncover patterns and insights that traditional analyses might miss. Through detailed visual representations, researchers and clinicians can better understand the effectiveness of different biomarkers and optimize therapeutic approaches accordingly. Here, we demonstrate how visualization techniques applied to FL data can highlight pivotal trends and interactions, driving forward the development of targeted immunotherapy treatments.

# Loading Functions

First, we load the necessary libraries and functions into the workspace.

```{r load, echo=FALSE, message=FALSE, warning=FALSE}

library(stringr)
app_dir <- str_split(rstudioapi::getActiveDocumentContext()$path,'PredictioR')[[1]][1]
dir <- file.path(app_dir, 'PredictioR', "result/FL/integrateAI_04122024") 

## load function from github repo: bhklab/PredictioR
source(file.path(app_dir, 'PredictioR', "R/getHR.R"))
source(file.path(app_dir, 'PredictioR', "R/getMetaAnalysis.R"))

#dir <- "C:/PredictioR/result/FL/integrateAI_04122024"
library(gridExtra)
library(grid)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(pheatmap)
library(RColorBrewer)

```

# Load federated learning data

We load the FL data shared by the DHDP FL team. This process involves retrieving datasets that are distributed across various institutions without compromising data privacy. We have loaded results for pan-cancer, per-cancer, and treatment-specific immunotherapy associations.

```{r load data}

# load pan-cancer, per-cancer, and treatment specific results
res.pan <- read.csv(file.path(dir, "pan_cancer.csv"))
res.percan <- read.csv(file.path(dir, "per_cancer.csv"))
res.pertreatment <- read.csv(file.path(dir, "per_treatment.csv"))

```


# Volcano Plots of Immunotherapy CD83 Biomarker Associations 

```{r volcano, include = FALSE}

# prepare pan-cancer data
df.pan <- res.pan
df.pan$FDR.FL <- p.adjust(df.pan$Pval.FL, method = "BH")

# prepare per-cancer Melanoma data
df.percan.melanoma <- res.percan[res.percan$Cancer_type =="Melanoma", ]
df.percan.melanoma$FDR.FL <- p.adjust(df.percan.melanoma$Pval.FL, method = "BH")

# prepare per-cancer Melanoma data
df.percan.kidney <- res.percan[res.percan$Cancer_type =="Kidney", ]
df.percan.kidney$FDR.FL <- p.adjust(df.percan.kidney$Pval.FL, method = "BH")

# prepare per-treatment PD-1/PD-L1 data
df.pertreatment <- res.pertreatment
df.pertreatment$FDR.FL <- p.adjust(df.pertreatment$Pval.FL, method = "BH")

```

We utilize volcano plots to visually represent the results of our analysis on immunotherapy biomarker associations. By plotting the negative log of the p-value against the effect size (i.e., logOR), these plots help us quickly identify biomarkers that show potentially significant differences in response to immunotherapy. 


```{r volcano1, message=FALSE, fig.width=8, fig.height=8, fig.cap = "Immunotherapy biomarker associations", fig.align="center"}

p1 <- volcanoPlot(feature = df.pan$Gene,
            coef = df.pan$coef.FL,
            pval = df.pan$Pval.FL,
            padj = df.pan$FDR.FL,
            neg.cutoff = 10,
            pos.cutoff = 1,
            x.lab = "logOR estimate (pan-cancer)",
            padj.label = TRUE,
            cutoff = 0.05)

p2 <- volcanoPlot(feature = df.percan.melanoma$Gene,
              coef = df.percan.melanoma$coef.FL,
              pval = df.percan.melanoma$Pval.FL,
              padj = df.percan.melanoma$FDR.FL,
              neg.cutoff = 10,
              pos.cutoff = 1,
              x.lab = "logOR estimate (melanoma)",
              padj.label = FALSE,
              cutoff = 0.05)

p3 <- volcanoPlot(feature = df.percan.kidney$Gene,
              coef = df.percan.kidney$coef.FL,
              pval = df.percan.kidney$Pval.FL,
              padj = df.percan.kidney$FDR.FL,
              neg.cutoff = 3,
              pos.cutoff = 3,
              x.lab = "logOR estimate (kidney)",
              padj.label = FALSE,
              cutoff = 0.05)


p4 <- volcanoPlot(feature = df.pertreatment$Gene,
            coef = df.pertreatment$coef.FL,
            pval = df.pertreatment$Pval.FL,
            padj = df.pertreatment$FDR.FL,
            neg.cutoff = 10,
            pos.cutoff = 1,
            x.lab = "logOR estimate (PD-1/PD-L1)",
            padj.label = TRUE,
            cutoff = 0.05)

grid.arrange(p1, p2, p3, p4, ncol = 2)


```


# Forestplot plots of Immunotherapy CD83 Biomarker Associations

We present forest plots to summarize the associations between the CD83 biomarker and its impact on immunotherapy responses across various analyses: pan-cancer, per-cancer (specifically melanoma), and per-treatment (PD-1/PD-L1). Through these plots, we aim to facilitate a better understanding of how CD83 correlations vary with patient responses to treatment across different immunotherapy studies.

```{r association, include = FALSE}

## association results per studies
dir0 <- "C:/PredictioR/result/FL/DHDP_03272024/result/association"
files <- list.files(dir0)

res.assoc <- lapply(1:length(files), function(k){

  read.csv(file.path(dir0, files[k]))

})

res.assoc <- do.call(rbind, res.assoc)

```

## pan-cancer

In the pan-cancer analysis, CD83 is negatively associated with immunotherapy response (logOR = -0.24, p=0.01), with no heterogeneity observed across studies.

```{r forestplot1, message=FALSE, warning=FALSE, fig.width=8, fig.height=5, fig.cap = "CD83 association with immunotherpay response: pan-cancer", fig.align="center"}

df <- res.assoc[res.assoc$Gene == "CD83", ]
forestPlot(coef = df$Coef,
           se = df$SE,
           study  = df$Study,
           pval = df$Pval,
           n = df$N,
           cancer.type = do.call(rbind, strsplit(df$Study, split='__', fixed=TRUE))[, 2],
           treatment = df$Treatment,
           feature = unique(df$Gene),
           xlab = "logOR estimate",
           label = "logOR")


```


## per-cancer: melanoma

In the per-cancer melanoma analysis, CD83 is negatively associated with immunotherapy response (logOR = -0.46, p = 0.02), with no significant heterogeneity observed across studies.

```{r forestplot2, message=FALSE, warning=FALSE, fig.width=8, fig.height=3, fig.cap = "CD83 association with immunotherpay response: per-cancer", fig.align="center"}

df.melanoma <- df[df$Cancer_type == "Melanoma", ]
forestPlot(coef = df.melanoma$Coef,
           se = df.melanoma$SE,
           study  = df.melanoma$Study,
           pval = df.melanoma$Pval,
           n = df.melanoma$N,
           cancer.type = do.call(rbind, strsplit(df.melanoma$Study, split='__', fixed=TRUE))[, 2],
           treatment = df.melanoma$Treatment,
           feature = unique(df.melanoma$Gene),
           xlab = "logOR estimate",
           label = "logOR")


```


## per-treatment: PD-1/PD-L1

In the per-treatment PD-1/PD-L1 analysis, CD83 is negatively associated with immunotherapy response (logOR = -0.22, p 0.03), with no heterogeneity observed across studies.

```{r forestplot3, message=FALSE, warning=FALSE, fig.width=8, fig.height=5, fig.cap = "CD83 association with immunotherpay response: per-treatment", fig.align="center"}

df.pd1 <- df[df$Treatment == "PD-(L)1", ]
forestPlot(coef = df.pd1$Coef,
           se = df.pd1$SE,
           study  = df.pd1$Study,
           pval = df.pd1$Pval,
           n = df.pd1$N,
           cancer.type = do.call(rbind, strsplit(df.pd1$Study, 
                                        split='__', fixed=TRUE))[, 2],
           treatment = df.pd1$Treatment,
           feature = unique(df$Gene),
           xlab = "logOR estimate",
           label = "logOR")

```


# Heatmap of Immunotherapy Biomarker Associations

Heatmap summarizing the FL data carried out on the biomrkers associated with immunotherpay response in the pan-cancer, the cancer-specific (melanoma), and treatment-specific (PD-1/PD-L1). Missing logOR information is shown as white boxes. P values were corrected for multiple testing
using the Benjaminie \& Hochberg false discovery rate (FDR) correction. Associations with FDR <0.05 are shown in black while those with an FDR >0.05 and a P value <0.05 are shown in gray.


```{r heatmap data, include = FALSE}

logreg.pan <- res.pan
logreg.pan$FDR.FL <- p.adjust(logreg.pan$Pval.FL, method = "BH")
logreg.pan <- logreg.pan[logreg.pan$FDR.FL < 0.05 | logreg.pan$Pval.FL < 0.05, ]
logreg.pan <- logreg.pan[logreg.pan$FDR < 0.05 | logreg.pan$Pval < 0.05, ]
logreg.pan <- logreg.pan[!is.na(logreg.pan$Coef), ]

logreg.melanoma <- res.percan[res.percan$Cancer_type == "Melanoma", ]
logreg.melanoma$FDR.FL <- p.adjust(logreg.melanoma$Pval.FL, method = "BH")
logreg.melanoma <- logreg.melanoma[logreg.melanoma$FDR.FL < 0.05 | logreg.melanoma$Pval.FL < 0.05, ]
logreg.melanoma <- logreg.melanoma[logreg.melanoma$FDR < 0.05 | logreg.melanoma$Pval < 0.05, ]
logreg.melanoma <- logreg.melanoma[!is.na(logreg.melanoma$Coef), ]

logreg.treatment <- res.pertreatment
logreg.treatment$FDR.FL <- p.adjust(logreg.treatment$Pval.FL, method = "BH")
logreg.treatment <- logreg.treatment[logreg.treatment$FDR.FL < 0.05 | logreg.treatment$Pval.FL < 0.05, ]
logreg.treatment <- logreg.treatment[logreg.treatment$FDR < 0.05 | logreg.treatment$Pval < 0.05, ]
logreg.treatment <- logreg.treatment[!is.na(logreg.treatment$Coef), ]

int <- union(union(logreg.melanoma$Gene, logreg.treatment$Gene), logreg.pan$Gene)

logreg.pan_mod <- lapply(1:length(int), function(k){

  if( sum(logreg.pan$Gene %in% int[k])>0 ){  
    res <- logreg.pan[logreg.pan$Gene %in% int[k], c("Gene", "coef.FL", "se.FL", "Pval.FL", "FDR.FL")] }else{

    res <-data.frame(Gene = int[k],
                     coef.FL = NA,
                     se.FL =NA,
                     Pval.FL = NA,
                     FDR.FL = NA)
  }

  res
})

logreg.pan <- do.call(rbind, logreg.pan_mod)
logreg.pan <- logreg.pan[order(logreg.pan$Gene), ]

logreg.melanoma_mod <- lapply(1:length(int), function(k){

  if( sum(logreg.melanoma$Gene %in% int[k])>0 ){  
    res <- logreg.melanoma[logreg.melanoma$Gene %in% int[k], c("Gene", "coef.FL", "se.FL", "Pval.FL", "FDR.FL")] }else{

    res <-data.frame(Gene = int[k],
                     coef.FL = NA,
                     se.FL =NA,
                     Pval.FL = NA,
                     FDR.FL = NA)
  }

  res
})

logreg.melanoma <- do.call(rbind, logreg.melanoma_mod)
logreg.melanoma <- logreg.melanoma[order(logreg.melanoma$Gene), ]

logreg.treatment_mod <- lapply(1:length(int), function(k){

  if( sum(logreg.treatment$Gene %in% int[k])>0 ){  
    res <- logreg.treatment[logreg.treatment$Gene %in% int[k], c("Gene", "coef.FL", "se.FL", "Pval.FL", "FDR.FL")] }else{

    res <-data.frame(Gene = int[k],
                     coef.FL = NA,
                     se.FL =NA,
                     Pval.FL = NA,
                     FDR.FL = NA)
  }

  res
})

logreg.treatment <- do.call(rbind, logreg.treatment_mod)
logreg.treatment <- logreg.treatment[order(logreg.treatment$Gene), ]

data = cbind( logreg.treatment$coef.FL , logreg.melanoma$coef.FL, logreg.pan$coef.FL )
rownames(data) = logreg.treatment$Gene
colnames(data) = c( "Treatment" , "Melanoma", "PanCancer" )

pval = cbind( logreg.treatment$Pval.FL , logreg.melanoma$Pval.FL, logreg.pan$Pval.FL )
rownames(pval) = logreg.treatment$Gene
colnames(pval) = c( "Treatment" , "Melanoma", "PanCancer" )
pval[ is.na(pval) ] = 1

padj = cbind( logreg.treatment$FDR.FL , logreg.melanoma$FDR.FL, logreg.pan$FDR.FL )
rownames(padj) = logreg.treatment$Gene
colnames(padj) = c( "Treatment" , "Melanoma", "PanCancer" )
padj[ is.na(padj) ] = 1

annot_col = data.frame(
  "PanCancer" = factor( ifelse( round( padj[ , 'PanCancer' ] , 2 ) <= .05 , 'FDR' , 
                                ifelse( round( pval[ , "PanCancer" ] , 2 ) <= 0.05 , "Pvalue" ,  'NS' ) ) ) ,
  Melanoma = factor( ifelse( round( padj[ , 'Melanoma' ] , 2 ) <= .05 , 'FDR' , 
                             ifelse( round( pval[ , "Melanoma" ] , 2 ) <= 0.05 , "Pvalue" , 'NS' ) ) ) ,
  "Treatment" = factor( ifelse( round( padj[ , 'Treatment' ] , 2 ) <= .05 , 'FDR' , 
                                ifelse( round( pval[ , "Treatment" ] , 2 ) <= 0.05 , "Pvalue" , 'NS' ) ) )
)

rownames(annot_col) = rownames(data)

ann_colors = list(
  "Treatment" = c( FDR = "#636363", Pvalue = "#bdbdbd", NS = "#f0f0f0" ) ,
  Melanoma = c( FDR = "#636363", Pvalue = "#bdbdbd", NS = "#f0f0f0" ),
  "PanCancer" = c( FDR = "#636363", Pvalue = "#bdbdbd", NS = "#f0f0f0" )
)

neg = seq( round( min( data , na.rm=TRUE ) , 1 ) , 0 , by=.05 )
neg = neg[ -length(neg)]
pos = seq( 0 , round( max( data , na.rm=TRUE ) , 1 ) , by=.05 )

col = c( colorRampPalette( rev( brewer.pal(4, "Blues") ) )( length(neg) ) ,
         colorRampPalette( brewer.pal(4, "OrRd") )( length(pos) )
)

```



```{r heatmap, message=FALSE, warning=FALSE, fig.width=10, fig.height=3, fig.cap = "Selected biomarkers associated with immunotherpay response", fig.align="center"}

df <- t( data[ order( rowSums(data)) , ] )
annot_col <- annot_col[colnames(df), ]

pheatmap( df , cluster_rows=FALSE , cluster_cols=FALSE , scale="none" ,
          annotation_col = annot_col,
          annotation_colors = ann_colors,
          name= "Coef",
          col = col , breaks = c( neg , pos ) , na_col="#f0f0f0" , border_color="#424242",
          number_color="black" , show_colnames = T, show_rownames = T,
          fontsize = 8, fontsize_number = 7)

```
